<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Generator Raportu</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background-color: #fff;
    }
    h1, h2 {
      text-align: center;
      color: #222;
    }
    h1 {
      margin-bottom: 20px;
      margin-top: 10px;
    }
    img {
      display: block;
      margin: 0 auto;
      height: 50px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="number"] {
      margin: 3px;
      padding: 5px;
      width: 180px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
    }
    textarea {
      resize: none;
      box-sizing: border-box;
      width: 100%;
      height: 250px;
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: monospace;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      font-weight: bold;
      font-size: 1rem;
    }
    #generateButton {
      background-color: #007bff;
      color: white;
    }
    #generateButton:hover {
      background-color: #0056b3;
    }
    #generateButton:active {
      transform: scale(0.98);
    }
    #sendToDiscord {
      background-color: #007bff;
      color: white;
    }
    #sendToDiscord:hover {
      background-color: #0056b3;
    }
    #sendToDiscord:active {
      transform: scale(0.98);
    }
    #clearOutput {
      background-color: #dc3545;
      color: white;
      margin-left: auto;
    }
    #clearOutput:hover {
      background-color: #b52a37;
    }
    #clearOutput:active {
      transform: scale(0.98);
    }
    .buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: space-between;
      align-items: center;
    }
    .left-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    @media (max-width: 500px) {
      input[type="number"] {
        width: 100%;
      }
      .inline-group {
        flex-direction: column;
      }
      .buttons-container {
        flex-direction: column;
        align-items: stretch;
      }
      .left-buttons {
        justify-content: center;
      }
      #clearOutput {
        margin-left: 0;
        width: 100%;
      }
      #generateButton, #sendToDiscord {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon logo" />
  <h2>Generator Raportu ATLAS</h2>

  <form id="reportForm" onsubmit="return false;">
    <label>OB Problem Solve units:</label>
    <input type="number" id="obUnits" required />

    <label>Opportunities:</label>
    <input type="number" id="opportunities" required />

    <label>Defect Count:</label>
    <input type="number" id="defectCount" required />

    <label>Missing Items:</label>
    <div class="inline-group">
      <input type="number" placeholder="Missing Items" id="missingItems" />
      <input type="number" placeholder="DPMO" id="missingItemsDPMO" />
      <input type="number" placeholder="Threshold" id="missingItemsTS" />
    </div>

    <label>Missing Shipments:</label>
    <div class="inline-group">
      <input type="number" placeholder="Missing Shipments" id="missingShipments" />
      <input type="number" placeholder="DPMO" id="missingShipmentsDPMO" />                      <!-- Poprawć podpis w Trobuble shot na poprawny  -->
      <input type="number" placeholder="Threshold" id="missingShipmentsTS" />
    </div>

    <label>Missing Tots:</label>
    <div class="inline-group">
      <input type="number" placeholder="Missing Tots" id="missingTots" />
      <input type="number" placeholder="DPMO" id="missingTotsDPMO" />                         
      <input type="number" placeholder="Threshold" id="missingTotsTS" />
    </div>

    <label>Overage:</label>
    <div class="inline-group">
      <input type="number" placeholder="Overage" id="overage" />
      <input type="number" placeholder="DPMO" id="overageDPMO" />
      <input type="number" placeholder="Threshold" id="overageTS" />
    </div>

    <label>Reprocessed Shipments:</label>
    <div class="inline-group">
      <input type="number" placeholder="Reprocessed Shipments" id="reprocessed" />
      <input type="number" placeholder="DPMO" id="reprocessedDPMO" />
      <input type="number" placeholder="Threshold" id="reprocessedTS" />
    </div>

    <div class="buttons-container">
      <div class="left-buttons">
        <button type="button" id="generateButton">Generuj raport</button>
        <button type="button" id="sendToDiscord">Wyślij na Slacka</button>
      </div>
      <button type="button" id="clearOutput">Wyczyść raport</button>
    </div>
  </form>

  <textarea id="output" readonly placeholder="Wygenerowany raport pojawi się tutaj..."></textarea>

  <script>
    function generateSection(label, countId, dpmoId, tsId, translation) {
      const count = document.getElementById(countId).value || "0";
      const dpmo = parseFloat(document.getElementById(dpmoId).value) || 0;
      const ts = parseFloat(document.getElementById(tsId).value) || 1;
      let percent = ts !== 0 ? Math.round((dpmo / ts) * 100) : 0;
      let line = `${label}: ${count} (${percent}%) DPMO ${dpmo}`;
      return { line, percent, count, translation };
    }

    document.getElementById("generateButton").addEventListener("click", function generateReport() {
      const obUnits = document.getElementById("obUnits").value || "0";
      const opportunities = document.getElementById("opportunities").value || "0";
      const defectCount = document.getElementById("defectCount").value || "0";

      const sections = [
        generateSection("Missing Items", "missingItems", "missingItemsDPMO", "missingItemsTS", "items were marked as Missing Item by Problem Solver and were not processed in the direct paths."),
        generateSection("Missing Shipments", "missingShipments", "missingShipmentsDPMO", "missingShipmentsTS", "items were marked as OB Missing Shipment defects."),
        generateSection("Missing Tots", "missingTots", "missingTotsDPMO", "missingTotsTS", "items were marked as Missing Totes defects mostly done by Problem Solver who processed IOL and FUD."),
        generateSection("Overage", "overage", "overageDPMO", "overageTS", "items were marked as Overages and later moved to the putback tote."),
        generateSection("Reprocessed Shipments", "reprocessed", "reprocessedDPMO", "reprocessedTS", "items were not processed correctly by Problem Solver and shipments were marked as reprocessed.")
      ];

      let report = `Dashboard DPMO: X brak update w stay clean\n` +
                   `OB Problem Solve units: ${obUnits} DPMO\n` +
                   `Opportunities: ${opportunities}\n` +
                   `Defect Count: ${defectCount}\n\n`;

      let has100 = false;
      let translations = [];
      for (const s of sections) {
        report += s.line + "\n";
        if (s.percent >= 100) {
          has100 = true;
          translations.push(`${s.count} ${s.translation}`);
        }
      }

      report += "\nRoot cause:\n";
      if (translations.length > 0) {
        report += translations.join("\n") + "\n";
      }
      report += has100
        ? "Top offenders identified. Feedback provided. Reminder to PS Team to follow shipment processing rules and standards."
        : "All in Targets";

      document.getElementById("output").value = report;
    });

    document.getElementById("sendToDiscord").addEventListener("click", async function sendReportToDiscord() {
      if (!confirm("Czy na pewno chcesz wysłać raport ? (Wysyłanie może to potrwać do 5 min)")) return;
      const report = document.getElementById("output").value.trim();
      if (!report) {
        alert("Najpierw wygeneruj raport!");
        return;
      }

      try {
        const response = await fetch("https://slack-proxy-a6zb.onrender.com/send-report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          mode: 'cors',
          body: JSON.stringify({ text: report })
        });

        if (response.ok) {
          alert("Raport został wysłany na Slacka!");
        } else {
          const text = await response.text();
          alert("Błąd podczas wysyłania: " + response.status + "\n" + text);
          console.error("Response error:", response, text);
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("Wystąpił błąd: " + error.message);
      }
    });

    document.getElementById("clearOutput").addEventListener("click", function() {
      document.getElementById("output").value = "";
    });
  </script>
</body>
</html>
